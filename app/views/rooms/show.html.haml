/ ================================
/ HEADER SECTION
/ ================================
= render 'links', page: "buy"

.container.mx-auto.px-4.py-6
	.bg-white.shadow-lg.rounded-xl.p-6.mb-8
		.flex.flex-col.md:flex-row.md:items-center.md:justify-between
			.mb-4.md:mb-0
				.text-2xl.font-bold.text-gray-900 Hi #{session[:user]["name"]}
				.text-sm.text-gray-500.mt-1 Welcome to your dashboard

				.text-sm.text-gray-500.mt-1
					- time_left = @room.end_date - Time.current
					- if time_left > 0
						- days = (time_left / 86400).to_i
						- hours = ((time_left % 86400) / 3600).to_i
						- minutes = ((time_left % 3600) / 60).to_i
						Time Left: #{days}d #{hours}h #{minutes}m
					- else
						Time Left: Expired


			.grid.grid-cols-2.md:grid-cols-4.gap-4.mt-4.md:mt-0
				.p-3.bg-gray-50.rounded-lg.shadow-sm.text-center
					.text-xs.text-gray-500 Room Code
					.text-lg.font-semibold.text-gray-900= @room.code

				.p-3.bg-gray-50.rounded-lg.shadow-sm.text-center
					.text-xs.text-gray-500 Spent Money 
					.text-lg.font-semibold.text-gray-900= @total_spent_price

				.p-3.bg-gray-50.rounded-lg.shadow-sm.text-center
					.text-xs.text-gray-500 Available Money
					.text-lg.font-semibold.text-gray-900= @total_available_price

				.p-3.bg-gray-50.rounded-lg.shadow-sm.text-center
					.text-xs.text-gray-500 Players Taken
					.text-lg.font-semibold.text-gray-900= @my_picked_players.count


.container.mx-auto.px-4.py-6.mt-2
	.flex.items-center.justify-between.mb-4
		%h2.text-xl.font-bold.text-gray-300 Available Players (#{@available_to_pick_players.values.sum(&:count)})

	.grid.grid-cols-2.sm:grid-cols-3.md:grid-cols-4.lg:grid-cols-6.gap-4
		- @available_to_pick_players.each do |country, players|
			%h3.text-md.font-semibold.text-gray-400.col-span-full.mt-4.mb-2 Country: #{country} (#{players.count})
			- players.each do |player|
				- plr = @auction_players.find {|ap| ap["id"] == player.player_id}
				- country_player_count = @country_wise_picked_players[country]&.count || 0
				-# .border.border-gray-200.bg-white.rounded-xl.shadow-sm.hover:shadow-md.transition.p-4.flex.flex-col
				.rounded-xl.shadow-sm.hover:shadow-md.transition.p-4.flex.flex-col.bg-gradient-to-br{ class: country_gradient(plr["country_code"]) }
					.flex.items-center.gap-3.mb-2
						.font-semibold.text-gray-900.text-sm= plr["name"]
						- if player.release_time > 1.hour.ago
							%span.relative.inline-flex.items-center.text-xs.font-semibold.text-white.rounded-full.px-2.py-0.5.bg-gradient-to-r.from-blue-500.via-blue-600.to-blue-700.shadow-md.overflow-hidden.w-fit
								%span.absolute{ style: "top:-20%; left:-40%; width:140%; height:60%; background: linear-gradient(90deg, rgba(255,255,255,0.65), rgba(255,255,255,0.12)); transform: rotate(-25deg); pointer-events: none;" }
								New

					-# .text-xs.text-gray-600.font-medium.text-gray-800.mb-2= plr["playertype"]

					.flex.w-full.justify-between.items-center.mt-1
						.text-xs.text-black
							.text-xs.text-center.font-bold.text-black= plr["odi_point"]
							.text-xs.text-center ODI

						.text-xs.text-black
							.text-xs.text-center.font-bold.text-black= plr["t20_point"]
							.text-xs.text-center T20

						.text-xs.text-black.flex.items-center.gap-1
							- if flag_url = country_flag(plr["country_code"])
								%img.inline-block.w-5.h-4.mr-1{ src: flag_url, alt: plr["country_code"] }
							.text-xs.text-center.font-bold.text-black= plr["country_code"]
							-# .text-xs.text-center Country
					

					- if @can_take_action && (player.release_time < Time.current)
						- if @my_picked_players.count >= 25
							%button.mt-4.w-full.text-xs.bg-gray-400.text-white.font-medium.py-1.5.rounded-lg.cursor-not-allowed Max players picked (â‚¹#{plr["price"]})
						- elsif @total_available_price < plr["price"]
							%button.mt-4.w-full.text-xs.bg-gray-400.text-white.font-medium.py-1.5.rounded-lg.cursor-not-allowed Not available fund (â‚¹#{plr["price"]})
						- elsif country_player_count >= 6
							%button.mt-4.w-full.text-xs.bg-gray-400.text-white.font-medium.py-1.5.rounded-lg.cursor-not-allowed Country limit reached
						- else
							= form_with url: pick_rooms_path, method: :post, class: "mt-4", data: { controller: "confirm-pick" } do |f|
								= f.hidden_field :picked_player_id, value: player["id"]

								%button.w-full.text-xs.font-medium.py-1.5.rounded-lg.transition{
									type: "button",
									class: country_button_style(plr["country_code"]),
									data: { action: "click->confirm-pick#open" }
								}
									Pick (â‚¹#{plr["price"]})

								-# %button.w-full.text-xs.bg-green-500.hover:bg-green-600.text-white.font-medium.py-1.5.rounded-lg.transition{
								-# 	type: "button",
								-# 	data: { action: "click->confirm-pick#open" }
								-# }
								-# 	Pick (â‚¹#{plr["price"]})

								/ ðŸ”” Confirmation Modal
								.fixed.inset-0.bg-black.bg-opacity-40.flex.items-center.justify-center.hidden{
									data: { confirm_pick_target: "modal" }
								}
									.bg-white.rounded-xl.shadow-xl.w-80.p-5
										%h3.text-sm.font-semibold.text-gray-800 Confirm Pick
										%p.text-xs.text-gray-600.mt-2
											Are you sure you want to pick this player for â‚¹#{plr["price"]}?

										.flex.justify-end.gap-2.mt-4
											%button.text-xs.px-3.py-1.5.rounded-md.bg-gray-200.hover:bg-gray-300.text-black{
												type: "button",
												data: { action: "click->confirm-pick#close" }
											}
												Cancel

											= f.submit "Confirm", class: "text-xs px-3 py-1.5 rounded-md bg-green-500 hover:bg-green-600 text-white font-medium"
